apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: admin
  annotations:
    flux.weave.works/automated: "false"
spec:
  releaseName: oauth2-proxy
  chart:
    repository: https://oauth2-proxy.github.io/manifests
    name: oauth2-proxy
    version: 6.0.0
  values:
    extraArgs:
      auth-logging: true
      cookie-httponly: false
      cookie-secure: true
      email-domain: "*"
      http-address: "0.0.0.0:4180"
      https-address: "0.0.0.0:4443"
      pass-authorization-header: true
      pass-basic-auth: false
      pass-host-header: true
      pass-user-headers: false
      provider: "azure"
      proxy-prefix: "/oauth-proxy"
      request-logging: true
      set-authorization-header: true
      set-xauthrequest: true
      skip-jwt-bearer-tokens: true
      skip-provider-button: true
      standard-logging: true
      tls-cert-file: "/var/oauth2/tls-cert"
      tls-key-file: "/var/oauth2/tls-cert"
      upstream: http://traefik-private:80/
    extraEnv:
      - name: OAUTH2_PROXY_CLIENT_ID
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-values
            key: client-id
      - name: OAUTH2_PROXY_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-values
            key: client-secret
      - name: OAUTH2_PROXY_AZURE_TENANT
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-values
            key: azure-tenant
      - name: OAUTH2_PROXY_EXTRA_JWT_ISSUERS
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-values
            key: extra-jwt-issuers
      - name: OAUTH2_PROXY_OIDC_ISSUER_URL
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-values
            key: oidc-issuer-url
    extraVolumes:
      - name: oauth2-proxy-cert
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: oauth2-proxy-cert
    extraVolumeMounts:
      - mountPath: "/var/oauth2"
        name: oauth2-proxy-cert
        readOnly: true
    httpScheme: https
    ingress:
      annotations:
        kubernetes.io/ingress.class: oauth2-proxy
      enabled: true
      hosts:
        - demo.platform.hmcts.net
      path: /
    podLabels:
      app: oauth2-proxy
      aadpodidbinding: oauth2-proxy
    proxyVarsAsSecrets: true
    resources:
      limits:
        cpu: 100m
        memory: 256Mi
      requests:
        cpu: 10m
        memory: 128Mi
    service:
      annotations: 
        service.beta.kubernetes.io/azure-load-balancer-internal: "true"
      portNumber: 443
    serviceAccount:
      enabled: true
    valuesFrom:
      - name: "oauth2-proxy-values"
        kind: Secret