apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: admin
  annotations:
    flux.weave.works/automated: "false"
spec:
  releaseName: oauth2-proxy
  chart:
    repository: https://oauth2-proxy.github.io/manifests
    name: oauth2-proxy
    version: 6.0.0
  values:
    extraArgs:
      azure-tenant: "21ae17a1-694c-4005-8e0f-6a0e51c35a5f"
      cookie-httponly: false
      cookie-secure: true
      email-domain: "*"
      http-address: 4180
      https-address: 4443
      oidc-issuer-url: https://login.microsoftonline.com/21ae17a1-694c-4005-8e0f-6a0e51c35a5f/v2.0
      pass-basic-auth: false
      pass-host-header: true
      pass-user-headers: false
      provider: "azure"
      proxy-prefix: "/oauth-proxy"
      request-logging: true
      skip-provider-button: true
      tls-cert: "/var/oauth2/demo-platform-hmcts-crt.pem"
      tls-key: "/var/oauth2/demo-platform-hmcts-key.pem"
      upstream: http://traefik:80/
    extraVolumes:
      - name: oauth2-proxy-cert
        secret:
          secretName: oauth2-proxy-cert
    extraVolumeMounts:
      - mountPath: /var/oauth2
        name: oauth2-proxy-cert
    httpScheme: http
    ingress:
      annotations:
        kubernetes.io/ingress.class: oauth2-proxy
      enabled: true
      hosts:
        - demo.platform.hmcts.net
      path: /
    podLabels:
      app: oauth2-proxy
    proxyVarsAsSecrets: true
    resources:
      limits:
        cpu: 100m
        memory: 256Mi
      requests:
        cpu: 10m
        memory: 128Mi
    service:
      annotations: 
        service.beta.kubernetes.io/azure-load-balancer-internal: "true"
      portNumber: 80
    serviceAccount:
      enabled: true
    valuesFrom:
      - name: "oauth2-proxy-values"
        kind: Secret