apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../darts-api/image-repo.yaml
  - ../darts-api/image-policy.yaml
  - ../darts-portal/image-repo.yaml
  - ../darts-portal/image-policy.yaml
  - ../darts-gateway/image-repo.yaml
  - ../darts-gateway/image-policy.yaml
  - ../darts-stub-services/image-repo.yaml
  - ../darts-stub-services/image-policy.yaml
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base
  - ../identity/identity.yaml
  - ../darts-api/darts-api.yaml
  - ../darts-portal/darts-portal.yaml
  - ../darts-gateway/darts-gateway.yaml
  - ../../base/workload-identity
namespace: darts-modernisation
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: darts-modernisation
  namespace: flux-system
spec:
  path: ./apps/darts-modernisation/${ENVIRONMENT}/${CLUSTER}
  postBuild:
    substitute:
      NAMESPACE: "darts-modernisation"
      TEAM_NOTIFICATION_CHANNEL: "darts-builds"
      WI_NAME: darts
      TEAM_AAD_GROUP_ID: 87c8cf3d-ff9d-4d8f-8430-ccc737764435
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-api
  namespace: darts-modernisation
spec:
  releaseName: darts-api
  chart:
    spec:
      chart: ./stable/darts-api
      sourceRef:
        kind: GitRepository
        name: hmcts-charts
        namespace: flux-system
      interval: 1m
  values:
    java:
      image: sdshmctspublic.azurecr.io/darts/api:prod-199a3c7-20231120092112 # {"$imagepolicy": "flux-system:darts-api"}
      disableTraefikTls: true
    function:
      image: sdshmctspublic.azurecr.io/darts/api:prod-199a3c7-20231120092112 # {"$imagepolicy": "flux-system:darts-api"}
      environment:
        ATS_MODE: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-api
  namespace: darts-modernisation
spec:
  releaseName: darts-api
  values:
    java:
      ingressHost: darts-api.demo.platform.hmcts.net
      environment:
        DARTS_GATEWAY_URL: https://darts-gateway.demo.platform.hmcts.net
        DARTS_LOG_LEVEL: DEBUG
        RESTART_ME: '007'
    function:
      image: sdshmctspublic.azurecr.io/darts/api:prod-87ae4c2-20231117095200 # {"$imagepolicy": "flux-system:darts-api"}
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: darts-api
spec:
  imageRepositoryRef:
    name: darts-api
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: darts-api
spec:
  image: sdshmctspublic.azurecr.io/darts/api
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-api
  namespace: darts-modernisation
spec:
  releaseName: darts-api
  values:
    java:
      ingressHost: darts-api.platform.hmcts.net
      environment:
        DARTS_GATEWAY_URL: https://darts-gateway.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.apps.hmcts.net
        DARTS_LOG_LEVEL: DEBUG
        RESTART_ME: '007'
    function:
      image: sdshmctspublic.azurecr.io/darts/api:prod-87ae4c2-20231117095200 # {"$imagepolicy": "flux-system:darts-api"}
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-api
  namespace: darts-modernisation
spec:
  releaseName: darts-api
  values:
    java:
      ingressHost: darts-api.sandbox.platform.hmcts.net
      environment:
        DARTS_GATEWAY_URL: https://darts-gateway.sandbox.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.sandbox.apps.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-api
  namespace: darts-modernisation
spec:
  releaseName: darts-api
  values:
    java:
      ingressHost: darts-api.staging.platform.hmcts.net
      environment:
        DARTS_GATEWAY_URL: https://darts-gateway.staging.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.staging.platform.hmcts.net
        DARTS_LOG_LEVEL: DEBUG
        RESTART_ME: '007'
    function:
      image: sdshmctspublic.azurecr.io/darts/api:prod-199a3c7-20231120092112 # {"$imagepolicy": "flux-system:darts-api"}
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-api
  namespace: darts-modernisation
spec:
  releaseName: darts-api
  values:
    java:
      ingressHost: darts-api.test.platform.hmcts.net
      environment:
        DARTS_GATEWAY_URL: https://darts-gateway.test.platform.hmcts.net
        DARTS_LOG_LEVEL: DEBUG
        RESTART_ME: '007'
    function:
      image: sdshmctspublic.azurecr.io/darts/api:prod-87ae4c2-20231117095200 # {"$imagepolicy": "flux-system:darts-api"}
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  chart:
    spec:
      chart: ./stable/darts-gateway
      sourceRef:
        kind: GitRepository
        name: hmcts-charts
        namespace: flux-system
      interval: 1m
  values:
    java:
      image: sdshmctspublic.azurecr.io/darts/gateway:prod-c44565c-20231120083128 # {"$imagepolicy": "flux-system:darts-gateway"}
      disableTraefikTls: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  values:
    java:
      ingressHost: darts-gateway.demo.platform.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.demo.platform.hmcts.net
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: darts-gateway
spec:
  imageRepositoryRef:
    name: darts-gateway
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: darts-gateway
spec:
  image: sdshmctspublic.azurecr.io/darts/gateway
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  values:
    java:
      ingressHost: darts-gateway.platform.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.platform.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  values:
    java:
      ingressHost: darts-gateway.sandbox.platform.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.sandbox.platform.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  values:
    java:
      ingressHost: darts-gateway.staging.platform.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.staging.platform.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  values:
    java:
      ingressHost: darts-gateway.test.platform.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.test.platform.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-portal
spec:
  releaseName: darts-portal
  chart:
    spec:
      chart: ./stable/darts-portal
      sourceRef:
        kind: GitRepository
        name: hmcts-charts
        namespace: flux-system
      interval: 1m
  values:
    nodejs:
      image: sdshmctspublic.azurecr.io/darts/portal:prod-ba56cdd-20231120081204 # {"$imagepolicy": "flux-system:darts-portal"}
      disableTraefikTls: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-portal
  namespace: darts-modernisation
spec:
  releaseName: darts-portal
  values:
    nodejs:
      ingressHost: darts-portal.demo.apps.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.demo.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.demo.apps.hmcts.net
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: darts-portal
spec:
  imageRepositoryRef:
    name: darts-portal
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: darts-portal
spec:
  image: sdshmctspublic.azurecr.io/darts/portal
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-portal
  namespace: darts-modernisation
spec:
  releaseName: darts-portal
  values:
    nodejs:
      ingressHost: darts-portal.apps.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.apps.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-portal
  namespace: darts-modernisation
spec:
  releaseName: darts-portal
  values:
    nodejs:
      ingressHost: darts-portal.sandbox.apps.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.sandbox.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.sandbox.apps.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-portal
  namespace: darts-modernisation
spec:
  releaseName: darts-portal
  values:
    nodejs:
      ingressHost: darts-portal.staging.apps.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.staging.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.staging.apps.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-portal
  namespace: darts-modernisation
spec:
  releaseName: darts-portal
  values:
    nodejs:
      ingressHost: darts-portal.test.apps.hmcts.net
      environment:
        DARTS_API_URL: https://darts-api.test.platform.hmcts.net
        DARTS_PORTAL_URL: https://darts-portal.test.apps.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-stub-services
  namespace: darts-modernisation
spec:
  releaseName: darts-stub-services
  chart:
    spec:
      chart: ./stable/darts-stub-services
      sourceRef:
        kind: GitRepository
        name: hmcts-charts
        namespace: flux-system
      interval: 1m
  values:
    java:
      image: sdshmctspublic.azurecr.io/darts/stub-services:prod-1d79b95-20231116155309 # {"$imagepolicy": "flux-system:darts-stub-services"}
      disableTraefikTls: true
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-stub-services
  namespace: darts-modernisation
spec:
  releaseName: darts-stub-services
  values:
    java:
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: darts-stub-services
spec:
  imageRepositoryRef:
    name: darts-stub-services
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: darts-stub-services
spec:
  image: sdshmctspublic.azurecr.io/darts/stub-services
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-stub-services
  namespace: darts-modernisation
spec:
  releaseName: darts-stub-services
  values:
    java:
      ingressHost: darts-stub-services.sandbox.platform.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-stub-services
  namespace: darts-modernisation
spec:
  releaseName: darts-stub-services
  values:
    java:
      ingressHost: darts-stub-services.staging.platform.hmcts.net
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: darts-gateway
  namespace: darts-modernisation
spec:
  releaseName: darts-gateway
  values:
    java:
---
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzureIdentity
metadata:
  name: darts
  namespace: darts-modernisation
spec:
  type: 0
---
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzureIdentityBinding
metadata:
  name: darts-binding
  namespace: darts-modernisation
spec:
  azureIdentity: darts
  selector: darts
---
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzureIdentity
metadata:
  name: darts
  namespace: darts-modernisation
spec:
  resourceID: "/subscriptions/74dacd4f-a248-45bb-a2f0-af700dc4cf68/resourcegroups/managed-identities-stg-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/darts-stg-mi"
  clientID: "fceae308-5548-4e31-aceb-10752819869e"
---
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzureIdentity
metadata:
  name: darts
  namespace: darts-modernisation
spec:
  resourceID: "/subscriptions/3eec5bde-7feb-4566-bfb6-805df6e10b90/resourcegroups/managed-identities-test-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/darts-test-mi"
  clientID: "d8c88285-07e5-48bc-b676-597e388f9845"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${NAMESPACE}
  namespace: ${NAMESPACE}
  annotations:
    azure.workload.identity/client-id: "dabc096c-23f7-4ed1-97fd-b640514abc03"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${NAMESPACE}
  namespace: ${NAMESPACE}
  annotations:
    azure.workload.identity/client-id: "af187bd3-6d1e-4bda-adad-73f51383cd94"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${NAMESPACE}
  namespace: ${NAMESPACE}
  annotations:
    azure.workload.identity/client-id: "fceae308-5548-4e31-aceb-10752819869e"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${NAMESPACE}
  namespace: ${NAMESPACE}
  annotations:
    azure.workload.identity/client-id: "d8c88285-07e5-48bc-b676-597e388f9845"
