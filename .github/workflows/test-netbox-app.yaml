name: Netbox
run-name: Netbox
permissions:
  id-token: write
  contents: read
  actions: read
on:
  push:
    branches:
      - "main"
    paths:
      - /apps/netbox/ptlsbox/netbox.yaml
  workflow_dispatch:
jobs:
  netbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up kubelogin for non-interactive login
        uses: azure/use-kubelogin@v1
        with:
          kubelogin-version: 'v0.0.24'
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ae4401e2-f8e6-4bbd-9ced-f42c4dfaea70 
          tenant-id: 531ff96d-0ae9-462a-8d2d-bec7c0b42082 
          allow-no-subscriptions: true
      - uses: azure/aks-set-context@v3
        name: Get Aks context
        with:
          resource-group: 'ss-ptlsbox-00-rg'
          cluster-name: 'ss-ptlsbox-00-aks'
          subscription: DTS-SHAREDSERVICESPTL-SBOX
          admin: true
      - name: install testkube
        run: wget -qO - https://repo.testkube.io/key.pub | sudo apt-key add - && echo "deb https://repo.testkube.io/linux linux main" | sudo tee -a /etc/apt/sources.list && sudo apt-get update && sudo apt-get install -y testkube
      - name: delete netbox test resource
        run: |
              /usr/bin/env bash
              [[ testkube get test netbox ]] && [[ testkube delete test netbox ]]
      - name: Create a test resource for netbox
        run: testkube create test --file pipeline-testkube/testkube-netbox.json --name netbox --type "curl/test"
      - name: Run test
        run: testkube run test netbox
      - name: sleep
        run:  sleep 10
      - name: Get status
        run: testkube get execution --test netbox  -o json --limit 1 | jq -r '.results[].status'
      - name: delete netbox test resource
        run: testkube delete test netbox